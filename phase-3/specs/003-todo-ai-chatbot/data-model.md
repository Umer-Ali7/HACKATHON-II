# Data Model: Todo AI Chatbot (Modern UI Edition)

**Feature**: 003-todo-ai-chatbot
**Date**: 2026-02-06

## Entity Relationship Diagram (Text)

```
User
 ├── 1:N → Task
 ├── 1:N → Conversation
 └──────── Conversation
              └── 1:N → Message
```

## Entities

### User

Represents a registered account managed by Better Auth.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| id | String (UUID) | PK | Generated by Better Auth |
| email | String(255) | NOT NULL, UNIQUE | Login identifier |
| hashed_password | String | NOT NULL | Bcrypt hash via Better Auth |
| display_name | String(100) | nullable | Optional; shown in greeting |
| theme_preference | String(10) | nullable, default NULL | "light", "dark", or NULL (system) |
| created_at | DateTime(tz) | NOT NULL, default now() | Immutable |
| updated_at | DateTime(tz) | NOT NULL, auto-update | |

**Indexes**:
- `ix_user_email` on `(email)` UNIQUE — login lookup

**Validation rules**:
- `email` MUST be a valid email format, max 255 characters.
- `hashed_password` is managed by Better Auth; never exposed in API responses.
- `display_name` MUST be 1–100 characters when provided.
- `theme_preference` MUST be one of `"light"`, `"dark"`, or `NULL`.

---

### Task

Represents a single todo item owned by a user.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| id | Integer | PK, auto-increment | |
| user_id | String | NOT NULL, FK → user.id | Owner |
| title | String(255) | NOT NULL, max 255 chars | Task title from natural language |
| description | String (text) | nullable | Optional task details |
| completed | Boolean | NOT NULL, default FALSE | Task completion status |
| created_at | DateTime(tz) | NOT NULL, default now() | Immutable creation timestamp |
| updated_at | DateTime(tz) | NOT NULL, auto-update | Updates on any field change |

**Indexes**:
- `ix_task_user_id` on `(user_id)` — filter tasks by user
- `ix_task_user_completed` on `(user_id, completed)` — filter by user + status

**Validation rules**:
- `title` MUST be 1–255 characters, non-empty after trimming.
- `user_id` MUST reference an existing user.
- `completed` transitions: `false → true` (complete), `true → false` (reopen, future scope).

---

### Conversation

Represents a chat session. Contains an ordered sequence of messages.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| id | Integer | PK, auto-increment | |
| user_id | String | NOT NULL, FK → user.id | Owner |
| created_at | DateTime(tz) | NOT NULL, default now() | Immutable |
| updated_at | DateTime(tz) | NOT NULL, auto-update | Updated when new message added |

**Indexes**:
- `ix_conversation_user_id` on `(user_id)` — list conversations by user

**Validation rules**:
- `user_id` MUST reference an existing user.
- A conversation MUST belong to exactly one user.

---

### Message

Represents a single message within a conversation. Immutable once created.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| id | Integer | PK, auto-increment | |
| conversation_id | Integer | NOT NULL, FK → conversation.id | Parent conversation |
| user_id | String | NOT NULL, indexed | Denormalized for query efficiency |
| role | String | NOT NULL, enum: "user" or "assistant" | Message sender role |
| content | String (text) | NOT NULL | Message body text |
| tool_calls | JSON | nullable | MCP tool calls metadata (assistant only) |
| created_at | DateTime(tz) | NOT NULL, default now() | Immutable; used for ordering |

**Indexes**:
- `ix_message_conversation_created` on `(conversation_id, created_at)` — ordered message retrieval
- `ix_message_user_id` on `(user_id)` — user isolation queries

**Validation rules**:
- `role` MUST be exactly `"user"` or `"assistant"`.
- `content` MUST be a non-empty string.
- `content` MUST NOT exceed 10,000 characters.
- `tool_calls` is only set on assistant messages; null for user messages.
- Messages are immutable — no update or delete operations.

---

## State Transitions

### Task Lifecycle

```
[created] ──complete──→ [completed]
              ↑              │
              └──reopen──────┘  (future scope, not in this phase)

[any state] ──delete──→ [removed]
```

### Conversation Lifecycle

```
[created] ──add messages──→ [active]
              (conversations are never deleted in this scope)
```

### User Account Lifecycle

```
[signup] ──verify──→ [active] ──delete account──→ [removed]
                        │
                        └──update profile──→ [active]
```

## Migration Strategy

- Use Alembic for all schema changes.
- Initial migration creates all 4 tables with indexes.
- All migrations MUST be reversible (include downgrade).
- Naming convention: `{revision_id}_{description}.py`
- Better Auth may manage User table directly; coordinate schema.
